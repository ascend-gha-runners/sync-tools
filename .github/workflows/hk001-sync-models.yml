name: HK001 Sync Models
on:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/config/hk001-models.json"
      - ".github/workflows/hk001-sync-models.yml"

concurrency:
  group: hk001-sync-models-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sync_models:
    runs-on: linux-aarch64-sync-hk001
    container:
      image: python:3.11-slim
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y jq

      - name: Set up Python environment
        run: |
          pip install --upgrade pip
          pip install filelock modelscope datasets huggingface_hub

      - name: Download models based on platform
        run: |
          echo "Reading model configurations from .github/workflows/config/hk001-models.json"
          
          # Read and process each model configuration
          jq -c '.[]' .github/workflows/config/hk001-models.json | while IFS= read -r model_config; do
            platform=$(echo "$model_config" | jq -r '.platform')
            organization=$(echo "$model_config" | jq -r '.organization')
            model_name=$(echo "$model_config" | jq -r '.model_name')
            
            echo "Processing model: $organization/$model_name from $platform"
            
            if [ "$platform" = "modelscope" ]; then
              echo "Downloading from ModelScope to default path..."
              modelscope download --model "$organization/$model_name" || echo "Failed to download $organization/$model_name from ModelScope"
              
            elif [ "$platform" = "huggingface" ]; then
              echo "Downloading from HuggingFace to /root/.cache/models/$organization/$model_name..."
              download_path="/root/.cache/models/$organization/$model_name"
              mkdir -p "$download_path" || { echo "Failed to create directory $download_path"; exit 1; }
              
              # Download using huggingface_hub Python API
              python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='$organization/$model_name', local_dir='$download_path', local_dir_use_symlinks=False)" || echo "Failed to download $organization/$model_name from HuggingFace"
              
            else
              echo "Unknown platform: $platform. Skipping $organization/$model_name"
            fi
            
            echo "Completed processing $organization/$model_name"
            echo "---"
          done