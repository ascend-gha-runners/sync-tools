name: Sync Images Between Registries

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # at every hour
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/sync-images.yml"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/sync-images.yml"

concurrency:
  group: sync-images-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-hk-to-quay:
    name: Sync from HK SWR to Quay
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    steps:
      - name: sync hk2quay
        run: |
          skopeo sync --all \
            --src docker --dest docker \
            ${{ vars.REGISTRY_HK }}/base_image/ascend-ci/sglang \
            quay.io/ascend/

  sync-quay-to-swr:
    name: Sync from Quay to SWR Southwest
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    strategy:
      matrix:
        repo: ["cann", "vllm-ascend", "manylinux", "llamafactory", "triton", "mindspore", "python", "pytorch"]
    steps:
      - name: Sync quay.io/ascend/${{ matrix.repo }} to SWR Southwest
        run: |
          skopeo sync --all \
            --src docker --dest docker \
            --dest-creds ${{ vars.HWCLOUD_USER }}:${{ secrets.HWCLOUD_PWD }} \
            quay.io/ascend/${{ matrix.repo }} \
            ${{ vars.REGISTRY_SW_2 }}/base_image/ascend-ci/${{ matrix.repo }}

  sync-swr-regions:
    name: Sync between SWR regions (sglang)
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    steps:
      - name: Sync SWR Southeast to East for sglang
        run: |
          skopeo sync --all \
            --src docker --dest docker \
            --src-creds ${{ secrets.HWCLOUD_USER }}:${{ secrets.HWCLOUD_PWD }} \
            --dest-creds ${{ secrets.HWCLOUD_EAST_USER }}:${{ secrets.HWCLOUD_EAST_PWD }} \
            ${{ vars.REGISTRY_HK }}/base_image/ascend-ci/sglang \
            ${{ vars.REGISTRY_EAST_4 }}/base_image/ascend-ci/sglang
