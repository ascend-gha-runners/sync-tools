name: Sync Images Between Registries

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"
  #pull_request:
  #  branches:
  #    - main
  #  paths:
  #    - ".github/workflows/sync-images.yml"
  #push:
  #  branches:
  #    - main
  #  paths:
  #    - ".github/workflows/sync-images.yml"

concurrency:
  group: sync-images-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-hk-to-quay:
    name: Sync from HK SWR to Quay
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    steps:
      - name: sync hk2quay
        run: |
          skopeo sync --all \
            --src docker --dest docker \
            --dest-creds ${{ vars.QUAY_ASCEND_USER }}:${{ secrets.QUAY_ASCEND_PWD }} \
            ${{ vars.REGISTRY_HK }}/base_image/ascend-ci/sglang \
            quay.io/ascend/

  sync-quay-to-swr:
    name: Sync from Quay to SWR Southwest
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    strategy:
      matrix:
        repo: ["cann", "manylinux", "llamafactory", "triton", "mindspore", "python", "pytorch"]
    steps:
      - name: Sync quay.io/ascend/${{ matrix.repo }} to SWR Southwest
        run: |
          skopeo sync --all \
            --retry-times 3 \
            --retry-delay 5s \
            --src docker --dest docker \
            --dest-creds ${{ vars.HWCLOUD_USER }}:${{ secrets.HWCLOUD_PWD }} \
            quay.io/ascend/${{ matrix.repo }} \
            ${{ vars.REGISTRY_SW_2 }}/base_image/ascend-ci/${{ matrix.repo }}

  sync-swr-regions:
    name: Sync between SWR regions (sglang)
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    steps:
      - name: Sync SWR Southeast to East for sglang
        run: |
          skopeo sync --all \
            --src docker --dest docker \
            --src-creds ${{ secrets.HWCLOUD_USER }}:${{ secrets.HWCLOUD_PWD }} \
            --dest-creds ${{ secrets.HWCLOUD_EAST_USER }}:${{ secrets.HWCLOUD_EAST_PWD }} \
            ${{ vars.REGISTRY_HK }}/base_image/ascend-ci/sglang \
            ${{ vars.REGISTRY_EAST_4 }}/base_image/ascend-ci/sglang

  sync-sglang-cann-tags:
    name: Sync lmsysorg/sglang CANN-related tags to SWR
    runs-on: ubuntu-latest
    container:
      image: quay.io/skopeo/stable:latest
    steps:
      - name: Install jq and curl using yum
        run: |
          # æ£€æŸ¥å¯ç”¨çš„åŒ…ç®¡ç†å™¨
          if command -v yum &> /dev/null; then
            echo "Using yum package manager"
            yum update -y
            yum install -y jq curl
          elif command -v dnf &> /dev/null; then
            echo "Using dnf package manager"  
            dnf update -y
            dnf install -y jq curl
          elif command -v microdnf &> /dev/null; then
            echo "Using microdnf package manager"
            microdnf update -y
            microdnf install -y jq curl
          else
            echo "Error: No supported package manager found"
            exit 1
          fi
          
          # éªŒè¯å®‰è£…
          jq --version
          curl --version

      - name: Debug environment variables
        run: |
          echo "Debug: Checking if registry variables are set:"
          echo "REGISTRY_SW_2: ${REGISTRY_SW_2:-Not set}"
          echo "HWCLOUD_USER length: ${#HWCLOUD_USER} chars"
          echo "HWCLOUD_PWD length: ${#HWCLOUD_PWD} chars (secret)"

      - name: Fetch all tags and filter CANN-related ones
        id: get-cann-tags
        run: |
          echo "Debug: Testing DockerHub API connection..."
          API_RESPONSE=$(curl -s -w "\nHTTP Status: %{http_code}" "https://hub.docker.com/v2/repositories/lmsysorg/sglang/tags/?page_size=1")
          echo "API Response: $API_RESPONSE"
          
          echo "Debug: Fetching all tags..."
          # èŽ·å–æ‰€æœ‰åˆ†é¡µçš„tags
          TAGS=""
          NEXT_URL="https://hub.docker.com/v2/repositories/lmsysorg/sglang/tags/?page_size=100"
          PAGE=1
          
          while [ "$NEXT_URL" != "null" ] && [ $PAGE -le 10 ]; do
            echo "Fetching page $PAGE: $NEXT_URL"
            RESPONSE=$(curl -s "$NEXT_URL")
            PAGE_TAGS=$(echo "$RESPONSE" | jq -r '.results[] | select(.name | test("cann"; "i")) | .name' 2>/dev/null || echo "")
            
            if [ -n "$PAGE_TAGS" ]; then
              TAGS="$TAGS"$'\n'"$PAGE_TAGS"
            fi
            
            NEXT_URL=$(echo "$RESPONSE" | jq -r '.next // "null"')
            PAGE=$((PAGE + 1))
          done
          
          # æ¸…ç†å’Œæ ¼å¼åŒ–tags
          TAGS=$(echo "$TAGS" | sed '/^$/d' | sort -u)
          
          echo "Debug: Number of tags found: $(echo "$TAGS" | wc -l)"
          echo "Found CANN-related tags:"
          echo "$TAGS"
          
          # å®‰å…¨è¾“å‡ºåˆ°GITHUB_OUTPUT
          if [ -n "$TAGS" ]; then
            echo "tags=$(echo "$TAGS" | tr '\n' ' ' | xargs)" >> $GITHUB_OUTPUT
          else
            echo "tags=" >> $GITHUB_OUTPUT
          fi

      - name: Debug tags output
        run: |
          echo "Debug: Output from get-cann-tags step:"
          echo "Tags variable: '${{ steps.get-cann-tags.outputs.tags }}'"
          
          if [ -n "${{ steps.get-cann-tags.outputs.tags }}" ]; then
            echo "Debug: Split tags for verification:"
            IFS=' ' read -ra TAG_ARRAY <<< "${{ steps.get-cann-tags.outputs.tags }}"
            for tag in "${TAG_ARRAY[@]}"; do
              echo "Tag: $tag"
            done
          else
            echo "Debug: No tags found"
          fi

      - name: Test skopeo connection
        run: |
          echo "Debug: Testing skopeo connection to source registry..."
          skopeo inspect --retry-times 1 docker://docker.io/lmsysorg/sglang:latest || echo "Debug: Skopeo inspect test completed"

      - name: Sync each CANN-related tag
        if: steps.get-cann-tags.outputs.tags != ''
        run: |
          echo "Debug: Starting sync process..."
          TAGS="${{ steps.get-cann-tags.outputs.tags }}"
          
          for tag in $TAGS; do
            echo "Syncing tag: $tag"
            if skopeo copy \
              --retry-times 3 \
              --src-no-creds \
              --dest-creds "${{ vars.HWCLOUD_USER }}:${{ secrets.HWCLOUD_PWD }}" \
              docker://docker.io/lmsysorg/sglang:$tag \
              docker://${{ vars.REGISTRY_SW_2 }}/base_image/dockerhub/lmsysorg/sglang:$tag; then
              echo "âœ… Successfully synced tag: $tag"
            else
              echo "âŒ Failed to sync tag: $tag"
              exit 1
            fi
          done
          echo "ðŸŽ‰ All tags synced successfully"

      - name: No tags found message
        if: steps.get-cann-tags.outputs.tags == ''
        run: |
          echo "â„¹ï¸ No CANN-related tags found to sync"
